#include <WiFi.h>
#include <FirebaseESP32.h>
#include "DHT.h"
#include "time.h"

// -----------------------------
// Wi-Fi
// -----------------------------
#define WIFI_SSID "ZTE_2.4G_kmjuMc"
#define WIFI_PASSWORD "xsY6Mhdi"

// -----------------------------
// Firebase
// -----------------------------
#define API_KEY "AIzaSyAv_ZS8PLXoTcDIXkE-deVKgTPgIUchKJc"
#define DATABASE_URL "https://intelliroom-50474-default-rtdb.asia-southeast1.firebasedatabase.app/"

// -----------------------------
// Pins
// -----------------------------
#define DHTPIN 4
#define DHTTYPE DHT11
#define RELAY_PIN 5

DHT dht(DHTPIN, DHTTYPE);
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// -----------------------------
// Variables
// -----------------------------
float temperature;
bool manualMode = false;
bool manualFanState = false;
int TEMP_THRESHOLD = 30;
float lastTemp = -100;
bool lastFanState = false;

// Logging timer
unsigned long lastLogTime = 0;
const unsigned long LOG_INTERVAL = 60000; // 1 minute logging interval

// -----------------------------
// NTP Time
// -----------------------------
const char* ntpServer = "time.google.com";
const long gmtOffset_sec = 8 * 3600;  // GMT+8
const int daylightOffset_sec = 0;

// -----------------------------
// Get timestamp function
// -----------------------------
String getTimestamp() {
  struct tm timeinfo;
  if (!getLocalTime(&timeinfo)) {
    return "unknown-time";
  }

  char buffer[25];
  strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", &timeinfo);
  return String(buffer);
}

// -----------------------------
// Setup
// -----------------------------
void setup() {
  Serial.begin(115200);
  dht.begin();

  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW);

  // WiFi
  Serial.print("Connecting to WiFi");
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nConnected to WiFi!");

  // Sync NTP
  configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
  struct tm timeinfo;
  while (!getLocalTime(&timeinfo)) {
    Serial.println("Waiting for NTP time...");
    delay(1000);
  }
  Serial.println("Time synchronized");

  // Firebase Setup
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Serial.println("Connected to Firebase");
}

// -----------------------------
// Main Loop
// -----------------------------
void loop() {

  // Read temperature
  temperature = dht.readTemperature();
  if (isnan(temperature)) {
    Serial.println("Failed to read DHT11!");
    delay(1500);
    return;
  }

  Serial.print("Temperature: ");
  Serial.println(temperature);

  // Read Firebase manual mode
  if (Firebase.getBool(fbdo, "/intelliroom/manualMode"))
    manualMode = fbdo.boolData();

  if (Firebase.getBool(fbdo, "/intelliroom/manualFanState"))
    manualFanState = fbdo.boolData();

  // Automatic or manual fan control
  bool fanOn = (!manualMode) ? (temperature >= TEMP_THRESHOLD) : manualFanState;

  // Only update when changed
  if (fanOn != lastFanState) {
    digitalWrite(RELAY_PIN, fanOn ? HIGH : LOW);
    Firebase.setString(fbdo, "/intelliroom/fanStatus", fanOn ? "ON" : "OFF");
    lastFanState = fanOn;
    Serial.println(fanOn ? "Fan ON" : "Fan OFF");
  }

  // Upload temperature only if changed
  if (abs(temperature - lastTemp) >= 0.5) {
    Firebase.setFloat(fbdo, "/intelliroom/temperature", temperature);
    lastTemp = temperature;
  }

  // Upload mode
  Firebase.setBool(fbdo, "/intelliroom/currentModeIsManual", manualMode);

  // -----------------------------
  // Temperature Logging Every 1 Minute
  // -----------------------------
  unsigned long currentMillis = millis();

  if (currentMillis - lastLogTime >= LOG_INTERVAL) {
    String timestamp = getTimestamp();

    String datePath = timestamp.substring(0, 10); // YYYY-MM-DD
    String timePath = timestamp.substring(11);    // HH:MM:SS

    String fullPath = "/temperatureLogs/" + datePath + "/" + timePath;

    Serial.print("Saving log: ");
    Serial.print(fullPath);
    Serial.print(" = ");
    Serial.println(temperature);

    Firebase.setFloat(fbdo, fullPath, temperature);

    lastLogTime = currentMillis;
  }

  delay(1500);
}
